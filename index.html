<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Mapa de Supervis√µes - Cidades</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body { margin:0; height:100%; width:100%; font-family:Arial, sans-serif; }
    #map { height:100%; width:100%; }

    .panel{
      position:absolute; top:10px; left:10px; z-index:1000; background:#fff; padding:10px;
      border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.25); font-size:13px; max-width:280px;
    }
    .panel h4{margin:0 0 6px; font-size:14px; display:flex; justify-content:space-between;align-items:center;}
    .panel select{width:100%; padding:4px; margin-bottom:6px;}

    .legend-item{display:flex;align-items:center;margin-bottom:3px;cursor:pointer;padding:2px 4px;border-radius:4px;}
    .legend-item:hover{background:#f0f0f0;}
    .legend-item.selected{background:#e0f5e9;font-weight:bold;}
    .legend-color{width:12px;height:12px;border-radius:50%;border:1px solid #333;margin-right:5px;}

    #toggleLegend{border:none;background:#e9f6ef;padding:3px 8px;border-radius:8px;font-size:11px;cursor:pointer;}

    /* MOBILE MODE */
    @media(max-width:768px){
      .panel{left:0;right:0;bottom:0;top:auto;width:100%;border-radius:12px 12px 0 0;}
      #legenda{max-height:200px;overflow-y:auto;}
    }

    /* üî• Labels s√≥ quando aproximado */
    .city-label{
      font-size:11px;
      font-weight:bold;
      color:#000;
      text-shadow:0 0 3px #fff,0 0 6px #fff;
      pointer-events:none;
      white-space:nowrap;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div class="panel" id="panel">
  <h4>Filtro de Supervis√£o <button id="toggleLegend">‚ñº</button></h4>
  <select id="filtro"><option value="">Todas</option></select>
  <div id="legenda"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/************** CONFIG **************/
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwnpVZijStuBl7uL1ONtJdP8or97kS0QKj8mQ111vbCNxeMOaBMvfXLI37F8XiKw2E/exec";
const MUNICIPIOS_GEOJSON = "municipios-br.geojson";
const SUPERVISOES_GEOJSON = "supervisoes.geojson";

const MUNICIPIOS_META_URL="https://raw.githubusercontent.com/kelvins/municipios-brasileiros/main/json/municipios.json";

const UF_MAP={11:"RO",12:"AC",13:"AM",14:"RR",15:"PA",16:"AP",17:"TO",21:"MA",22:"PI",23:"CE",24:"RN",
25:"PB",26:"PE",27:"AL",28:"SE",29:"BA",31:"MG",32:"ES",33:"RJ",35:"SP",41:"PR",42:"SC",43:"RS",
50:"MS",51:"MT",52:"GO",53:"DF"};

let map,layerMunicipios,layerSupOutlines,labelLayer;
let cidadeParaSupervisao={},UF_POR_ID={},GEO_CITY_FIELD=null,GEO_UF_FIELD=null;

/************** UTILS **************/
function normalizar(s){return String(s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"")
.replace(/[^A-Za-z0-9 ]/g," ").replace(/\s+/g," ").trim().toUpperCase();}
function chave(c,u){return normalizar(c)+"|"+normalizar(u);}
function detectar(props){
  for(const k in props){if(k.toUpperCase().includes("UF"))GEO_UF_FIELD=k;}
  ["NM_MUN","MUNICIPIO","MUNICIP","NOME","NAME"].forEach(k=>{if(props[k]&&!GEO_CITY_FIELD)GEO_CITY_FIELD=k;});
}
function obter(p){
  return{cidade:GEO_CITY_FIELD?p[GEO_CITY_FIELD]:"",uf:GEO_UF_FIELD?p[GEO_UF_FIELD]:UF_POR_ID[p.id]||""};
}

/************** MAP START **************/
async function iniciar(){
map=L.map("map").setView([-15,-53],5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18}).addTo(map);

document.getElementById("toggleLegend").onclick=()=>{
  let p=document.getElementById("panel");p.classList.toggle("collapsed");
  toggleLegend.textContent=p.classList.contains("collapsed")?"‚ñ≤":"‚ñº";
};

/* WEBAPP */
let dados=await fetch(WEBAPP_URL).then(r=>r.json());
dados.forEach(p=>{if(p.cidade&&p.uf&&p.supervisao)cidadeParaSupervisao[chave(p.cidade,p.uf)]=p.supervisao;});

/* UF METADATA */
let meta=await fetch(MUNICIPIOS_META_URL).then(r=>r.json());
meta.forEach(m=>{let uf=UF_MAP[m.codigo_uf];if(uf)UF_POR_ID[m.codigo_ibge]=uf});

/* MUNIC√çPIOS GEOJSON */
let json=await fetch(MUNICIPIOS_GEOJSON).then(r=>r.json());
detectar(json.features[0].properties);

layerMunicipios=L.geoJSON(json,{
 filter:f=>{
   let {cidade,uf}=obter(f.properties);
   return cidadeParaSupervisao[chave(cidade,uf)]!=null;
 },
 style:f=>({fillColor:cor(normalizar(cidadeParaSupervisao[chave(obter(f.properties).cidade,obter(f.properties).uf)])),
            fillOpacity:.6,weight:0,color:"#000"}),
 onEachFeature:(feat,layer)=>{
   let {cidade,uf}=obter(feat.properties),sup=cidadeParaSupervisao[chave(cidade,uf)];

   layer._supNorm=normalizar(sup);

   if(sup)layer.bindPopup(`<b>${cidade} - ${uf}</b><br>Supervis√£o: <b>${sup}</b>`);

   /* üî• ROTA√á√ÉO PARA APARECER S√ì COM ZOOM */
   feat._labelText=cidade;
   feat._labelPos=layer.getBounds().getCenter();
 }
}).addTo(map);

/*********** CONTORNOS **********/
let cont=await fetch(SUPERVISOES_GEOJSON).then(r=>r.json());
layerSupOutlines=L.geoJSON(cont,{
  style:f=>({color:"#000",weight:3,fillOpacity:0,opacity:1})
}).addTo(map).bringToBack();

/*********** LABEL DIN√ÇMICO **********/
labelLayer=L.layerGroup().addTo(map);
map.on("zoomend moveend",renderLabels);
renderLabels();

montarLegenda();
}

/*********** RENDERIZA√á√ÉO DE LABEL COM ZOOM **********/
function renderLabels(){
 labelLayer.clearLayers();
 if(map.getZoom()<6.5)return;  // üî• s√≥ exibe depois desse zoom

 layerMunicipios.eachLayer(l=>{
   let ft=l.feature;
   if(ft._labelText&&ft._labelPos){
     L.marker(ft._labelPos,{
       icon:L.divIcon({html:ft._labelText,className:"city-label",iconSize:[0,0]}),
       interactive:false
     }).addTo(labelLayer);
   }
 });
}

/*********** LEGENDA **********/
function montarLegenda(){
const sel=document.getElementById("filtro"),leg=document.getElementById("legenda");
let sups=new Set();
layerMunicipios.eachLayer(l=>sups.add(l._supNorm));
[...sups].sort().forEach(s=>{
  let div=document.createElement("div"),color=cor(s);
  div.className="legend-item";div.dataset.s=s;
  div.innerHTML=`<div class='legend-color' style='background:${color}'></div> ${s}`;
  div.onclick=()=>filtro(s);
  leg.appendChild(div);

  let op=document.createElement("option");
  op.value=s;op.textContent=s;sel.appendChild(op);
});
sel.onchange=e=>filtro(e.target.value);
}

/*********** FILTRO **********/
function filtro(sup){
layerMunicipios.eachLayer(l=>{
  let v=!sup||l._supNorm==sup;
  l.setStyle({fillOpacity:v?.6:0,opacity:v?1:0});
});
renderLabels();
}

/*********** CORES **********/
const CORES=["#ff1744","#d50000","#ff9100","#ffd600","#64dd17","#00c853","#0091ea","#304ffe",
"#aa00ff","#c51162","#ff6d00","#827717","#1b5e20","#006064","#1a237e","#311b92"];
function cor(key){return CORES[ Math.abs(hash(key)) % CORES.length ];}
function hash(s){return s.split("").reduce((a,b)=>a+b.charCodeAt(0),0);}

iniciar();
</script>
</body>
</html>
