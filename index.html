<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Mapa de Supervis√µes - Cidades</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>

  <style>
    html, body { margin:0; height:100%; width:100%; font-family:Arial, sans-serif; }
    #map { height:100%; width:100%; }

    .panel { position:absolute; top:10px; left:10px; z-index:1000; background:#fff; padding:10px;
      border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.25); font-size:13px; max-width:260px; }
    .panel h4 { margin:0 0 6px; font-size:14px; display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .panel select { width:100%; padding:4px; margin-bottom:6px; }

    .legend-item { display:flex; align-items:center; margin-bottom:3px; cursor:pointer;
      padding:2px 4px; border-radius:4px; }
    .legend-item:hover { background:#f0f0f0; }
    .legend-item.selected { background:#e0f5e9; font-weight:bold; }
    .legend-color { width:12px; height:12px; border-radius:50%; border:1px solid #333; margin-right:5px; }
    #toggleLegend { border:none; background:#e9f6ef; border-radius:12px; padding:2px 8px; font-size:11px; cursor:pointer; }

    .panel.collapsed select, .panel.collapsed #legenda { display:none; }
    .panel.collapsed { padding-bottom:6px; }

    /* MOBILE */
    @media(max-width:768px){
      .panel{ left:0; right:0; bottom:0; top:auto; max-width:none; width:100%; border-radius:12px 12px 0 0; }
      #legenda{ max-height:180px; overflow-y:auto; }
    }

    /* üî• LABEL DAS CIDADES SEMPRE VIS√çVEL */
    .city-label {
      font-size: 11px;
      font-weight: bold;
      color: #000;
      text-shadow: 1px 1px 4px #ffffff, -1px -1px 4px #ffffff;
      pointer-events: none;
      white-space: nowrap;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div class="panel" id="panel">
  <h4>Filtro de Supervis√£o <button id="toggleLegend">‚ñº</button></h4>
  <select id="filtro"><option value="">Todas</option></select>
  <div id="legenda"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/**************** CONFIG ****************/
const WEBAPP_URL ="https://script.google.com/macros/s/AKfycbwnpVZijStuBl7uL1ONtJdP8or97kS0QKj8mQ111vbCNxeMOaBMvfXLI37F8XiKw2E/exec";

const MUNICIPIOS_GEOJSON   = "municipios-br.geojson";
const SUPERVISOES_GEOJSON  = "supervisoes.geojson";

const MUNICIPIOS_META_URL ="https://raw.githubusercontent.com/kelvins/municipios-brasileiros/main/json/municipios.json";

const UF_MAP={11:"RO",12:"AC",13:"AM",14:"RR",15:"PA",16:"AP",17:"TO",21:"MA",22:"PI",23:"CE",
24:"RN",25:"PB",26:"PE",27:"AL",28:"SE",29:"BA",31:"MG",32:"ES",33:"RJ",35:"SP",41:"PR",42:"SC",
43:"RS",50:"MS",51:"MT",52:"GO",53:"DF"};

let map,layerMunicipios,layerSupOutlines;
let cidadeParaSupervisao={}, UF_POR_ID={}, GEO_CITY_FIELD=null,GEO_UF_FIELD=null;

/*************** FUN√á√ïES ***************/
function normalizar(str){return String(str||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"")
.replace(/[^A-Za-z0-9 ]/g," ").replace(/\s+/g," ").trim().toUpperCase();}
function chaveCidadeUF(c,u){return normalizar(c)+"|"+normalizar(u||"");}

/*************** INICIAR MAPA ***************/
async function iniciar(){
try{
 map=L.map("map").setView([-15.8,-47.9],5);
 L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18}).addTo(map);

 document.getElementById("toggleLegend").onclick=()=> {
   const p=document.getElementById("panel"); p.classList.toggle("collapsed");
   document.getElementById("toggleLegend").textContent=p.classList.contains("collapsed")?"‚ñ≤":"‚ñº";
 };

 const dadosPlanilha=await fetch(WEBAPP_URL).then(r=>r.json());
 dadosPlanilha.forEach(p=>{
    let c=normalizar(p.cidade),u=normalizar(p.uf); if(!c||!u||!p.supervisao)return;
    cidadeParaSupervisao[c+"|"+u]=p.supervisao;
 });

 const meta=await fetch(MUNICIPIOS_META_URL).then(r=>r.json());
 meta.forEach(m=>{let uf=UF_MAP[m.codigo_uf]; if(uf)UF_POR_ID[m.codigo_ibge]=uf;});

 const geojson=await fetch(MUNICIPIOS_GEOJSON).then(r=>r.json());
 detectar(geojson.features[0].properties);

 layerMunicipios=L.geoJSON(geojson,{
   filter:f=>{let {cidade,uf}=obter(f.properties);return cidadeParaSupervisao[chaveCidadeUF(cidade,uf)]},
   style:f=>({fillColor:cor(normalizar(cidadeParaSupervisao[chaveCidadeUF(obter(f.properties).cidade,
             obter(f.properties).uf)])),fillOpacity:.50,color:"#000",weight:0}),
   onEachFeature:(feat,layer)=>{
     let {cidade,uf}=obter(feat.properties),sup=cidadeParaSupervisao[chaveCidadeUF(cidade,uf)];
     if(sup)layer.bindPopup(`<b>${cidade} - ${uf}</b><br>Supervis√£o: <b>${sup}</b>`);

     /** üî• R√ìTULO FIXO NO MAPA **/
     const center=layer.getBounds().getCenter();
     L.marker(center,{icon:L.divIcon({className:"city-label",html:cidade,iconSize:[0,0]})}).addTo(map);
   }
 }).addTo(map);

 await carregarContornos(); montarLegenda();

}catch(err){alert("Erro: "+err.message);}
}

function detectar(p){for(const k in p){if(k.toUpperCase().includes("UF"))GEO_UF_FIELD=k;}
["NM_MUN","MUNICIP","NOME","NAME"].forEach(x=>{if(!GEO_CITY_FIELD&&p[x])GEO_CITY_FIELD=x;});}

function obter(p){
 return {cidade:GEO_CITY_FIELD?p[GEO_CITY_FIELD]:"", uf:GEO_UF_FIELD?p[GEO_UF_FIELD]:
        UF_POR_ID[p.id]||""};
}
function cor(s){return"#"+((1<<24)*Math.random()|0).toString(16).padStart(6,"0");}

/*************** CONTORNOS ***************/
async function carregarContornos(){
 const data=await fetch(SUPERVISOES_GEOJSON).then(r=>r.json());
 layerSupOutlines=L.geoJSON(data,{style:f=>({color:"#000",weight:3,fillOpacity:0,opacity:1}),
   interactive:false}).addTo(map).bringToBack();
}

/*************** LEGENDA & FILTRO ***************/
function montarLegenda(){
let sel=document.getElementById("filtro");
layerMunicipios.eachLayer(l=>{if(l._supNorm)sel.innerHTML+=`<option>${l._supNorm}</option>`;});
sel.onchange=()=>filtrar(sel.value);
}
function filtrar(sup){
layerMunicipios.eachLayer(l=>l.setStyle({fillOpacity:!sup||l._supNorm===sup?.50:0}));
}

iniciar();
</script>
</body>
</html>
